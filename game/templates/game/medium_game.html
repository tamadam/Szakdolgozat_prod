{% extends 'base_new.html' %}

{% load static %}

{% block content %}

<style>

#second-game-content{
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	width: 100%;
	height: 100%;
	background-color: white;
	background: none;	
	background-position: center;
	background-repeat: no-repeat;
	background-size: cover;
	user-select: none;
	font-family: 'Kanit', sans-serif;
	max-width: 1900px;
}

#second-game-header{
	display: flex;
	align-items: center;
	justify-content: center;
	width: 100%;
	height: 14%;
}

#second-game-container{
	display: flex;
	align-items: center;
	justify-content: center;	
	width: 100%;
	height: 72%;
}

#second-game-footer{
	display: flex;
	align-items: top;
	justify-content: center;	
	width: 100%;
	height: 14%;
}

#puzzle-container-left{
	display: flex;
	align-items: center;
	justify-content: center;
	width: 20%;
	height: 100%;
}

#puzzle-container{
	display: flex;
	align-items: center;
	justify-content: center;
	position: relative;
	width: 50vh;
	height: 50vh;
	background-color: rgba(0, 0, 0, 0.88);
	border: 6px solid transparent;
  	/*border-image: url("{% static 'images/button-back.png' %}") 30 stretch;*/
	padding: 1em;
}


#puzzle-container-right{
	display: flex;
	align-items: center;
	justify-content: center;
	width: 20%;
	height: 100%;
}

#timer-title{
	height: 40%;
	width: 100%;
	text-align: center;
}

#timer-text{
	height: 40%;
	width: 100%;
	text-align: center;
}

.puzzle-piece{
	top: 0;
	left: 0;
	display: flex;
	align-items: center;
	justify-content: center;
	position: absolute;
	width: 50%;
	height: 50%;
	background-color: lightblue;
	color: green;
	cursor: pointer;
	transition: 0.3s left, 0.3s top;

}

.puzzle-piece img{
	width: 100%;
	height: 100%;
	max-width: 100%;
	max-height: 100%;
	opacity: 1.0;
}


/* ---eddig a game---- */

/* --- title */
#second-game-title-left{
	width: 14%;
}

#second-game-title-center{
	width: 72%;
	display: flex;
	align-items: center;
	justify-content: center;
	text-align: center;
	font-family: 'Kanit', sans-serif;
	font-size: 1.4em;
	color: white;

}

#second-game-title-center-h1{
	display: flex;
	align-items: center;
	justify-content: center;
	padding: 1em;
	background-color: rgba(0, 0, 0, 0.6);
	height: 20%;
	color: #fae455;

}

#second-game-title-right{
	width: 14%;
}


#main-page-button {
	display: flex;
	justify-content: center;
	align-items: center; 
	width: 100%;
	height: 100%;

}

#main-page-button img{
	width: 40%;
	height: 40;
	max-width: 100%;
	max-height: 100%;

}

.go-to-main-page:hover {
	cursor: pointer;
}



.go-to-main-page:active {
	/*content:url("{% static 'images/previous-button-purple.png' %}");*/
}

.loader-container {
	width: 100%;
	height: 100%;
	position: absolute;
	top: 0;
	left: 0;
	background-color: black;
	display: flex;
	justify-content: center;
	align-items: center;
	z-index: 10;
	color: white;
	font-family: 'Kanit', sans-serif;
	font-size: 1.4em;

}



.result-container {
	width: 100%;
	height: 100%;
	position: absolute;
	top: 0;
	left: 0;
	background-color: rgba(239, 239, 240, 0.4);
	display: none;
	justify-content: center;
	align-items: center;
	z-index: 9;
	color: white;
	font-family: 'Kanit', sans-serif;
	font-size: 1.2em;

}

#result-message-container{
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	width: 14%;
	height: 20%;
	background-color: rgba(0, 0, 0, 0.9);
	border-radius: 20px;
	color: white;
	font-family: 'Kanit', sans-serif;
	font-size: 1.2em;
	padding: 0.4em;


}

#result-message{
	width: 100%;
	height: 78%;
	display: flex;
	flex-direction: row;
	align-items: center;
	justify-content: center;
}

#res-message{
	display: flex;
	align-items: center;
	justify-content: center;
	height: 100%;
	width: 50%;
}

#got-stat{
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	height: 100%;
	width: 20%;	
}


#got-stat-image{
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: flex-end;
	height: 80%;
	width: 100%;
}

#stat-image img{
	max-width: 90%;
	max-height: 90%;
}

#got-stat-text{
	display: flex;
	align-items: center;
	justify-content: center;
	height: 20%;
	width: 100%;
	font-size: 1em;
}




#result-button{
	font-size: 0.8em;
	width: 55%;
	height: 22%;
	display: flex;
	align-items: center;
	justify-content: center;
	background-color: white;
	background: none;	
	background-position: center;
	background-repeat: no-repeat;
	background-size: cover;
	color: black;

}


#result-button:hover{
	background: none;	
	background-position: center;
	background-repeat: no-repeat;
	background-size: cover;
	color: #fae455;
	cursor: pointer;
}

#puzzle-timer-container{
	font-family: 'Kanit', sans-serif;
	font-size: 1.4em;
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	color: #fae455;
	padding: 1em;
	width: 100%;
	user-select: none;
}

#timer-text{
	border-radius: 10px;
	padding: 0.4em;
	width: 20%;
	text-align: center;

}

#shuffle-status-text{
	display: flex;
	color: red;
	font-size: 1.4em;
}

#restart-button-container{
	height: 100%;
	width: 20%;
	display: none;
	align-items: center;
	justify-content: center;
}

#reload-arrow-button{
	max-height: 50%;
	max-width: 50%;
}

#reload-arrow-button:hover{
	cursor: pointer;
}

</style>

<div id="second-game-content">
	<div id="second-game-header">
		<div id="second-game-title-left">
			<div id="main-page-button">
				<img src="{% static 'images/previous-button.png' %}" alt="Vissza" class="go-to-main-page" onmouseover="changeColor(this)" onmouseout="resetColor(this)">
			</div>
		</div>
		<div id="second-game-title-center">
			<div id="second-game-title-center-h1">
				<h1>Puzzle mester</h1>
			</div>
		</div>
		<div id="second-game-title-right">	
		</div>
	</div>
	<div id="second-game-container">
		<div id="puzzle-container-left"></div>
		<div id="puzzle-container">
			
		</div>
		<div id="puzzle-container-right">
			<div id="puzzle-timer-container">
				<div id="timer-title">Hátralévő idő</div>
				<div id="timer-text">{{minutes}}:{{seconds}}</div>
			</div>
		</div>
	</div>
	<div id="second-game-footer">
		<div id="shuffle-status-text">Keverés...</div>
		<div id="restart-button-container">
			<img src="{% static 'images/reload-arrow.png' %}" alt="ujraindit" id="reload-arrow-button" onmouseover="changeRestartColor(this)" onmouseout="resetRestartColor(this)">
		</div>
	</div>
	<div class="result-container">
		<div id="result-message-container">
			<div id="result-message">
				<div id="got-stat">
					<div id="got-stat-image">
						<div id="stat-image">
							<img src="{% static 'images/coin.png' %}" alt="arany" id="gold-image">
						</div>
					</div>
					<div id="got-stat-text">
						<span id="gold-span">...</span>
					</div>
				</div>
				<div id="res-message">...</div>
				<div id="got-stat">

					<div id="got-stat-image">
						<div id="stat-image">
							<img src="{% static 'images/experience.png' %}" alt="xp" id="xp-image">
						</div>
					</div>
					<div id="got-stat-text">
						<span id="xp-span">...</span>
					</div>
				</div>
			</div>
			<div id="result-button">Rendben</div>
		</div>
	</div>
	<div class="loader-container">

	</div>
</div>




<script>

	// production

	$("#second-game-content").css("background-image", "url('{% static 'images/puzzle-background.jpg' %}')".replace(/&amp;/g, "&"));
	
	$("#puzzle-container").css("border-image", "url('{% static 'images/button-back.png' %}')".replace(/&amp;/g, "&"))

	$("#puzzle-container").css("border-image-repeat", "stretch")
	$("#puzzle-container").css("border-image-slice", "30%")


	$("#result-button").css("background-image", "url('{% static 'images/button-back.png' %}')".replace(/&amp;/g, "&"))

	$("#result-button").hover(function() {
	    $("#result-button").css("background-image", "url('{% static 'images/button-back-red.png' %}')".replace(/&amp;/g, "&"))
	  },
	  function() {
	    $("#result-button").css("background-image", "url('{% static 'images/button-back.png' %}')".replace(/&amp;/g, "&"));
	  }
	)





	//

	$(window).on("load", function(){
		$(".loader-container").fadeOut("slow")


	})


	$("#result-button").click(function(){
		audio.play()
		$(".result-container").css("display", "none")
		animateGoBackButton()
		setInterval(animateGoBackButton, 1250)
	})

	function animateGoBackButton(){

		$("#main-page-button").animate({
			opacity: "1.0"
		}, 600, function(){
			$(this).animate({
				opacity: "0.4"
			}, 600)
		})
	}


	const audio = new Audio()
	audio.src = "{% static 'audios/button_click.mp3' %}".replace(/&amp;/g, "&")



	const puzzleSwap = new Audio()
	puzzleSwap.src = "{% static 'audios/puzzle-swap.mp3' %}".replace(/&amp;/g, "&")


	function changeRestartColor(imageElement){
		imageElement.setAttribute("src", "{% static 'images/reload-arrow-red.png' %}".replace(/&amp;/g, "&"))
	}

	function resetRestartColor(imageElement){
		imageElement.setAttribute("src", "{% static 'images/reload-arrow.png' %}".replace(/&amp;/g, "&"))
	}

	$("#reload-arrow-button").on("click", function(){
		audio.play()
		setTimeout(function(){
			location.reload()
		}, 200)
	})




	function changeColor(imageElement){
		imageElement.setAttribute("src", "{% static 'images/previous-button-red.png' %}".replace(/&amp;/g, "&"))
	}

	function resetColor(imageElement){
		imageElement.setAttribute("src", "{% static 'images/previous-button.png' %}".replace(/&amp;/g, "&"))
	}


	$(".go-to-main-page").click(function(){
    	audio.play()

    	setTimeout(function(){
	    	try {

				var url = "{% url 'game:game_choice' %}"
				var win = window.location.replace(url) 
				win.focus()
			}
			catch(error){
				console.log(error)
			}

    	}, 200)
    	$(".loader-container").fadeIn("fast")
	})





	// puzzle játék //
	const images2x2 = [
		{ name: "1", image: "{% static 'images/puzzle-images/2x2/1.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "2", image: "{% static 'images/puzzle-images/2x2/2.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "3", image: "{% static 'images/puzzle-images/2x2/3.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "4", image: "{% static 'images/puzzle-images/2x2/4.jpg' %}".replace(/&amp;/g, "&") },
	]
	const images3x3 = [
		{ name: "1", image: "{% static 'images/puzzle-images/3x3/1.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "2", image: "{% static 'images/puzzle-images/3x3/2.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "3", image: "{% static 'images/puzzle-images/3x3/3.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "4", image: "{% static 'images/puzzle-images/3x3/4.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "5", image: "{% static 'images/puzzle-images/3x3/5.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "6", image: "{% static 'images/puzzle-images/3x3/6.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "7", image: "{% static 'images/puzzle-images/3x3/7.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "8", image: "{% static 'images/puzzle-images/3x3/8.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "9", image: "{% static 'images/puzzle-images/3x3/9.jpg' %}".replace(/&amp;/g, "&") },
	]

	const images4x4 = [
		{ name: "1", image: "{% static 'images/puzzle-images/4x4/1.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "2", image: "{% static 'images/puzzle-images/4x4/2.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "3", image: "{% static 'images/puzzle-images/4x4/3.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "4", image: "{% static 'images/puzzle-images/4x4/4.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "5", image: "{% static 'images/puzzle-images/4x4/5.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "6", image: "{% static 'images/puzzle-images/4x4/6.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "7", image: "{% static 'images/puzzle-images/4x4/7.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "8", image: "{% static 'images/puzzle-images/4x4/8.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "9", image: "{% static 'images/puzzle-images/4x4/9.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "10", image: "{% static 'images/puzzle-images/4x4/10.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "11", image: "{% static 'images/puzzle-images/4x4/11.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "12", image: "{% static 'images/puzzle-images/4x4/12.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "13", image: "{% static 'images/puzzle-images/4x4/13.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "14", image: "{% static 'images/puzzle-images/4x4/14.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "15", image: "{% static 'images/puzzle-images/4x4/15.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "16", image: "{% static 'images/puzzle-images/4x4/16.jpg' %}".replace(/&amp;/g, "&") },
	]

	const images5x5 = [
		{ name: "1", image: "{% static 'images/puzzle-images/5x5/1.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "2", image: "{% static 'images/puzzle-images/5x5/2.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "3", image: "{% static 'images/puzzle-images/5x5/3.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "4", image: "{% static 'images/puzzle-images/5x5/4.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "5", image: "{% static 'images/puzzle-images/5x5/5.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "6", image: "{% static 'images/puzzle-images/5x5/6.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "7", image: "{% static 'images/puzzle-images/5x5/7.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "8", image: "{% static 'images/puzzle-images/5x5/8.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "9", image: "{% static 'images/puzzle-images/5x5/9.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "10", image: "{% static 'images/puzzle-images/5x5/10.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "11", image: "{% static 'images/puzzle-images/5x5/11.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "12", image: "{% static 'images/puzzle-images/5x5/12.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "13", image: "{% static 'images/puzzle-images/5x5/13.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "14", image: "{% static 'images/puzzle-images/5x5/14.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "15", image: "{% static 'images/puzzle-images/5x5/15.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "16", image: "{% static 'images/puzzle-images/5x5/16.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "17", image: "{% static 'images/puzzle-images/5x5/17.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "18", image: "{% static 'images/puzzle-images/5x5/18.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "19", image: "{% static 'images/puzzle-images/5x5/19.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "20", image: "{% static 'images/puzzle-images/5x5/20.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "21", image: "{% static 'images/puzzle-images/5x5/21.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "22", image: "{% static 'images/puzzle-images/5x5/22.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "23", image: "{% static 'images/puzzle-images/5x5/23.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "24", image: "{% static 'images/puzzle-images/5x5/24.jpg' %}".replace(/&amp;/g, "&") },
		{ name: "25", image: "{% static 'images/puzzle-images/5x5/25.jpg' %}".replace(/&amp;/g, "&") },
	]

	var initialValue = null
	var rows = null
	var cols = null
	var fieldSize = null
	var puzzlePiecesContainer = null
	var puzzlePieces = null
	var emptyPieceCoordinate = null
	var emptyPieceID = null
	var arrayIdOfPieces = []

	var pieceWidth = null
	var pieceHeight = null

	var imageSource = null
	var pieceSizeBasedOnFieldSize = null

	var disablePuzzleField = true
	var minutes = null
	var seconds = null
	var timerInterval = null
	var animateStarted = false
	var animateRedBackgroundInterval = null

	var shuffleEnd = false

	function initializeGame(){
		var shuffleMultiplier = setInitialValues()

		createPuzzlePieces()
		alignPiecesProperPosition()
		setTimeout(function(){
			generateTime()
			shufflePieces(shuffleMultiplier * initialValue)
			disablePuzzleField = false
			shuffleEnd = true
			$("#shuffle-status-text").css("display", "none")
		}, 1000)
		timerInterval = setInterval(generateTime, 1000)

	}

	function setInitialValues(){
		try{
			initialValue = {{game_field_size}}
			minutes = {{minutes}}
			seconds = {{seconds}}
		}
		catch{
			initialValue = 3
			minutes = 0
			seconds = 50
		}
		rows = initialValue
		cols = initialValue
		fieldSize = cols * rows
		emptyPieceCoordinate = [rows - 1, cols -1]
		emptyPieceID = fieldSize - 1

		var shuffleMultiplier = 10

		if (initialValue == 2){
			imageSource = images2x2
			pieceSizeBasedOnFieldSize = "50%"
		}
		else if(initialValue == 3){
			imageSource = images3x3
			pieceSizeBasedOnFieldSize = "33.3%"
			shuffleMultiplier = 15
		}
		else if(initialValue == 4){
			imageSource = images4x4
			pieceSizeBasedOnFieldSize = "25%"
			shuffleMultiplier = 20
		}
		else if(initialValue == 5){
			imageSource = images5x5
			pieceSizeBasedOnFieldSize = "20%"
			shuffleMultiplier = 25
		}
		else{
			imageSource = images2x2
			pieceSizeBasedOnFieldSize = "50%"
		}


		return shuffleMultiplier

	}

	// legeneráljuk a megadott számú div-et (a puzzle darabjait)
	function createPuzzlePieces(){
		puzzlePiecesContainer = document.getElementById("puzzle-container")
		for (let i = 0; i < fieldSize - 1; i++){
			var puzzleElement = document.createElement("div")
			puzzleElement.classList.add("puzzle-piece")
			puzzleElement.style.width = pieceSizeBasedOnFieldSize
			puzzleElement.style.height = pieceSizeBasedOnFieldSize
			//puzzleElement.innerHTML = i + 1

			var puzzleElementImage = document.createElement("img")
			puzzleElementImage.src = imageSource[i].image

			puzzleElement.appendChild(puzzleElementImage)

			puzzlePiecesContainer.appendChild(puzzleElement)
		}

		// puzzlePiecesben benne van az összes darab
		puzzlePieces = document.getElementsByClassName("puzzle-piece")
		pieceWidth = puzzlePieces[0].clientWidth
		pieceHeight = puzzlePieces[0].clientHeight
	}


	// végigmegyünk a puzzle darabokon, a megfelelő helyre helyezzük őket
	// onclick event listenert is itt adjuk hozzá, valamint egy tömbbe is rakjuk őket
	function alignPiecesProperPosition(){
		for (let i = 0; i < rows; i++){
			for (let j = 0; j < cols; j++){
				var puzzlePieceID = (i * cols) + j
				if (puzzlePieceID >= fieldSize - 1){
					break
				}

				var puzzlePiece = puzzlePieces[puzzlePieceID]

				puzzlePiece.addEventListener("click", handleClickOnPiece.bind(null, event, puzzlePieceID))

				alignPuzzlePiece(puzzlePiece, i, j)

				arrayIdOfPieces.push(puzzlePieceID)

			}
		}

		arrayIdOfPieces.push(emptyPieceID)
	}


	function alignPuzzlePiece(puzzlePiece, rowIndex, colIndex){
		puzzlePiece.style.left = (colIndex * pieceWidth) + "px"
		puzzlePiece.style.top = (rowIndex * pieceHeight) + "px"
	}


	function handleClickOnPiece(event, puzzlePieceID){
		//console.log("puzzle piece " + puzzlePieceID + " clicked")
		console.log(disablePuzzleField)
		if(!disablePuzzleField){
			var isMoved = moveClickedPiece(puzzlePieceID)

			if(isMoved){
				if(isPuzzleCompleted()){
					endPuzzleGame(true)
				}
				else{
					disablePuzzleField = false
				}
			}
		}
	}



	function moveClickedPiece(puzzlePieceID){
		var puzzlePiece = puzzlePieces[puzzlePieceID]

		var newCoordinate = getCoordinateIfMovableOrNull(puzzlePiece)

		if(newCoordinate){
			if (shuffleEnd){
				puzzleSwap.currentTime = 0
				puzzleSwap.play()
			}

			alignPuzzlePiece(puzzlePiece, emptyPieceCoordinate[1], emptyPieceCoordinate[0])


			// az eddigi üres rész helyére eltároljuk a kattintott puzzle ID-ját
			arrayIdOfPieces[emptyPieceCoordinate[0] + (emptyPieceCoordinate[1] * cols)] = puzzlePieceID

			// a kattintot puzzle darab koordinátáit átírjuk az üresre
			emptyPieceCoordinate[0] = newCoordinate[0]
			emptyPieceCoordinate[1] = newCoordinate[1]

			arrayIdOfPieces[emptyPieceCoordinate[0] + (emptyPieceCoordinate[1] * cols)] = emptyPieceID

			return true
		}

		return false
	}


	function getCoordinateIfMovableOrNull(puzzlePiece){
		var piecePositionX = parseInt(puzzlePiece.style.left)
		var piecePositionY = parseInt(puzzlePiece.style.top)

		var pieceCoordinate = [piecePositionX / pieceWidth, piecePositionY / pieceHeight]

		//console.log("FIX: pieceWidth " + pieceWidth + " | heightWidth" + pieceHeight)
		//console.log("piecePositionX " + piecePositionX + " | " + "piecePositionY " + piecePositionY)


		// a kattintott és az üres koordinátái
		//console.log("pieceCoordinateX " + pieceCoordinate[0] + " | pieceCoordinateY " + pieceCoordinate[1])
		//console.log("emptyPieceCoordinateX " + emptyPieceCoordinate[0] + " | emptyPieceCoordinateY " + emptyPieceCoordinate[1])


		var xAxisDifference = Math.abs(pieceCoordinate[0] - emptyPieceCoordinate[0])
		var yAxisDifference = Math.abs(pieceCoordinate[1] - emptyPieceCoordinate[1])

		//console.log("xAxisDifference " + xAxisDifference)
		//console.log("yAxisDifference " + yAxisDifference)

		var distance = [xAxisDifference, yAxisDifference]


		if ((distance[0] == 1 && distance[1] == 0) || (distance[0] == 0 && distance[1] == 1)){
			return pieceCoordinate
		}

		return null

	}


	function isPuzzleCompleted(){
		for (let i = 0; i < arrayIdOfPieces.length; i++){
			if (arrayIdOfPieces[i] != i){
				return false
			}
		}

		return true
	}


	function shufflePieces(numberOfShuffle){
		// a fieldSize az 3x3 esetén 9, abból 1 az üres, és az ID-k 0-7ig vannak
		// random ID 0 és 7 között
		//Math.floor(Math.random() * (max + 1));
		for (let i = 0; i < numberOfShuffle; i++){
			var randomPieceID = Math.floor(Math.random() * (fieldSize - 1))
			//console.log(randomPieceID)

			if (!moveClickedPiece(randomPieceID)){
				// ha olyat akar mozgatni amit nem lehet, akkor növeljük a keverések számát
				numberOfShuffle++
			}
		}


		if(isPuzzleCompleted()){
			// előfordulhat, hogy a keverés végére kirakva kapja meg a felhasználó a puzzle-t
			// ebben az esetben újrakezdjük a keverést
			shufflePieces(numberOfShuffle)
		}

	}


	function endPuzzleGame(isWin){
		disablePuzzleField = true
		clearInterval(timerInterval)
		if (animateStarted){
			clearInterval(animateRedBackgroundInterval)
			$("#timer-text").css("backgroundColor", "rgba(255, 0, 0, 1.0)")
		}


		if(isWin){
			console.log("VEGE - GYOZELEM")
			var finalPuzzlePiece = document.createElement("div")
			finalPuzzlePiece.classList.add("puzzle-piece")
			finalPuzzlePiece.style.width = pieceSizeBasedOnFieldSize
			finalPuzzlePiece.style.height = pieceSizeBasedOnFieldSize
			finalPuzzlePiece.style.opacity = "0"
			finalPuzzlePiece.setAttribute("id", "final-puzzle-piece")

			var finalPuzzleImage = document.createElement("img")
			finalPuzzleImage.src = imageSource.slice(-1)[0].image

			finalPuzzlePiece.appendChild(finalPuzzleImage)
			puzzlePiecesContainer.appendChild(finalPuzzlePiece)

			alignPuzzlePiece(finalPuzzlePiece, rows-1, cols-1)

			setTimeout(function(){
				$("#final-puzzle-piece").animate({
					opacity: 1.0
				}, 400)
			}, 400)

			addGoldAndIncreaseXpOnWin("second")
		}
		else{
			console.log("VEGE - VERESEG")
			$("#xp-span").html("0")
			$("#gold-span").html("0")
			$("#res-message").html("Vesztettél!")
		}

		setTimeout(function(){
			$(".result-container").css("display", "flex")
			$("#restart-button-container").css("display", "flex")
		}, 400)

	}




	function generateTime(){
		if(minutes == 0 && seconds == 0){
			document.getElementById("timer-text").innerHTML = "0:00"
			return endPuzzleGame(false)
		}	
		if (seconds == -1){
			if (minutes >= 1){
				minutes -= 1
				seconds = 59
			}
			else{
				return endPuzzleGame(false)
			}
		}

		var formatSeconds = ""
		if (seconds < 10){
			formatSeconds = "0" + seconds
		}
		else{
			formatSeconds = "" + seconds
		}


		var result = minutes + ":" + formatSeconds

		if (minutes == 0 && seconds <= 10){
			if (!animateStarted){
				animateStarted = true
				startTimerDangerAnimation()
			}

		}

		seconds -= 1



		document.getElementById("timer-text").innerHTML = result
	}


	function startTimerDangerAnimation(){
		$("#timer-text").css("backgroundColor", "rgba(255, 0, 0, 1.0)")
		$("#timer-text").css("color", "white")

		animateRedBackground()
		animateRedBackgroundInterval = setInterval(animateRedBackground, 1400)
	}

	function animateRedBackground(){
		$("#timer-text").animate({
			backgroundColor: "rgba(255, 0, 0, 0.2)"
		}, 600, function(){
			$(this).animate({
				backgroundColor: "rgba(255, 0, 0, 1.0)"
			}, 600)
		})
		
	}








	initializeGame()

	// ----------- // 
	var userID = "{{user_id}}"


	function addGoldAndIncreaseXpOnWin(gameType){
		console.log("increase")
		info_packet = {
			"user_id": "{{user_id}}",
			"game_type": gameType,
			"game_level_puzzle": initialValue,
		}
		$.ajax({

			dataType: "json",
			url: "{% url 'game:finished_game' %}",
			data: info_packet,

			success: function(data) {
				setStatValues(data)
			},
			error: function(data) {
				console.log('ERROR')
			},
		})
	}


	function setStatValues(data){
		$("#xp-span").html(data.got_xp)
		$("#gold-span").html(data.got_gold)
		$("#res-message").html("Győztél!")
	}
</script>


{% endblock %}